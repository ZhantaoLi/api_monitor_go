<!DOCTYPE html>
<html lang="en" class="dark">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>API Monitor - Log Viewer</title>

  <!-- Shared Utils (auth, theme, etc.) -->
  <script src="/static/assets/main.js"></script>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            zinc: { 850: '#26262a', 900: '#1e1e21', 950: '#121215' }
          }
        }
      }
    }
  </script>

  <!-- Phosphor Icons -->
  <script src="https://unpkg.com/@phosphor-icons/web"></script>

  <!-- Alpine.js -->
  <script defer src="https://cdn.jsdelivr.net/npm/@alpinejs/collapse@3.x.x/dist/cdn.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

  <!-- Shared Assets -->
  <link rel="stylesheet" href="/static/assets/styles.css">
  <script src="/static/assets/main.js"></script>
  <style>
    .hide-scrollbar {
      scrollbar-width: none;
      -ms-overflow-style: none;
    }

    .hide-scrollbar::-webkit-scrollbar {
      display: none;
    }
  </style>
</head>

<body
  class="bg-zinc-100 dark:bg-zinc-950 text-zinc-900 dark:text-zinc-100 h-screen bg-grid transition-colors duration-300 overflow-hidden flex flex-col"
  x-data="logViewer()">

  <!-- Header -->
  <header
    class="h-14 bg-white/80 dark:bg-zinc-900/80 backdrop-blur-md border-b border-zinc-200 dark:border-zinc-800 flex items-center justify-between px-4 shrink-0 z-20">
    <div class="flex items-center gap-4">
      <a href="/"
        class="flex items-center gap-2 text-zinc-500 hover:text-zinc-900 dark:hover:text-zinc-100 transition-colors">
        <i class="ph-bold ph-arrow-left"></i>
        <span class="font-bold">Back</span>
      </a>
      <div class="h-6 w-px bg-zinc-200 dark:bg-zinc-800"></div>
      <div class="flex items-center gap-2">
        <span class="font-bold text-lg" x-text="target.name || 'Loading...'"></span>
        <span class="text-xs px-2 py-0.5 rounded-full font-mono bg-zinc-100 dark:bg-zinc-800 text-zinc-500"
          x-text="target.base_url"></span>
      </div>
    </div>

    <div class="flex items-center gap-3">
      <!-- Analysis Button -->
      <a :href="`/analysis.html?target_id=${targetId}`"
        class="flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-indigo-600 hover:bg-indigo-500 text-white text-xs font-bold transition-all shadow-lg shadow-indigo-500/20 active:scale-95">
        <i class="ph-bold ph-chart-line-up"></i>
        <span>Visual Analysis</span>
      </a>

      <!-- Search -->
      <div class="relative w-64">
        <i class="ph-bold ph-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-zinc-400 text-sm"></i>
        <input type="text" x-model="search" placeholder="Search logs..."
          class="w-full bg-zinc-50 dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-800 rounded-lg pl-9 pr-3 py-1.5 text-sm focus:outline-none focus:border-indigo-500 dark:focus:border-indigo-500 transition-colors">
      </div>

      <!-- Status Filter -->
      <div class="relative">
        <select x-model="filterStatus"
          class="appearance-none bg-zinc-50 dark:bg-zinc-900 border border-zinc-200 dark:border-zinc-800 rounded-lg pl-3 pr-8 py-1.5 text-sm focus:outline-none focus:border-indigo-500 dark:focus:border-indigo-500 transition-colors cursor-pointer">
          <option value="all">All Status</option>
          <option value="success">Success</option>
          <option value="fail">Failed</option>
        </select>
        <i
          class="ph-bold ph-caret-down absolute right-3 top-1/2 -translate-y-1/2 text-zinc-400 text-xs pointer-events-none"></i>
      </div>


    </div>
  </header>

  <!-- Main Content (Split Pane) -->
  <main class="flex-1 flex overflow-hidden">
    <!-- Left Pane: List -->
    <div
      class="w-1/3 min-w-[320px] max-w-md border-r border-zinc-200 dark:border-zinc-800 flex flex-col bg-white/80 dark:bg-zinc-900/60 backdrop-blur-md">
      <!-- Stats -->
      <div class="p-3 border-b border-zinc-200 dark:border-zinc-800 grid grid-cols-2 gap-2 text-xs">
        <div class="bg-zinc-50 dark:bg-zinc-800/50 p-2 rounded-lg text-center">
          <div class="text-zinc-500 mb-0.5">Success Rate</div>
          <div class="font-bold text-green-500" x-text="stats.successRate + '%'"></div>
        </div>
        <div class="bg-zinc-50 dark:bg-zinc-800/50 p-2 rounded-lg text-center">
          <div class="text-zinc-500 mb-0.5">Avg Latency</div>
          <div class="font-bold text-indigo-500" x-text="stats.avgLatency + 's'"></div>
        </div>
      </div>

      <!-- List -->
      <div class="flex-1 overflow-y-auto hide-scrollbar p-2 space-y-2">
        <template x-if="filteredLogs.length === 0 && !loading">
          <div class="text-center py-10 text-zinc-500">
            <i class="ph-duotone ph-list-dashes text-3xl mb-2 opacity-50"></i>
            <p class="text-sm">No logs found</p>
          </div>
        </template>

        <template x-for="log in filteredLogs" :key="log.id || log.timestamp">
          <div @click="selectLog(log)"
            class="p-3 rounded-lg border cursor-pointer transition-all hover:bg-zinc-50 dark:hover:bg-zinc-800/50 group relative"
            :class="selectedId === log.id ? 'bg-indigo-50 dark:bg-indigo-500/10 border-indigo-200 dark:border-indigo-500/30' : 'bg-white dark:bg-zinc-900 border-zinc-200 dark:border-zinc-800'">

            <!-- Status Bar -->
            <div class="absolute left-0 top-3 bottom-3 w-1 rounded-r-full"
              :class="log.success ? 'bg-green-500' : 'bg-red-500'"></div>

            <div class="pl-3">
              <div class="flex items-center justify-between mb-1">
                <span class="font-bold text-sm truncate pr-2" x-text="log.model"></span>
                <span class="font-mono text-xs text-zinc-400" x-text="Utils.fmtTime(log.timestamp)"></span>
              </div>
              <div class="flex items-center justify-between text-xs">
                <div class="flex items-center gap-2">
                  <span class="px-1.5 py-0.5 rounded-md font-mono"
                    :class="log.success ? 'bg-green-100 dark:bg-green-500/20 text-green-700 dark:text-green-400' : 'bg-red-100 dark:bg-red-500/20 text-red-700 dark:text-red-400'"
                    x-text="log.status_code || (log.success ? 200 : 'ERR')"></span>
                  <span class="text-zinc-500" x-text="log.protocol"></span>
                </div>
                <span class="font-mono" :class="log.duration > 2 ? 'text-orange-500' : 'text-zinc-500'"
                  x-text="log.duration.toFixed(2) + 's'"></span>
              </div>
            </div>
          </div>
        </template>
      </div>
      <!-- Pagination/Load More Footer -->
      <div class="p-2 border-t border-zinc-200 dark:border-zinc-800 text-center text-xs text-zinc-500">
        <span x-text="`Showing ${filteredLogs.length} logs`"></span>
      </div>
    </div>

    <!-- Right Pane: Details -->
    <div class="flex-1 bg-white/60 dark:bg-zinc-900/40 backdrop-blur-sm flex flex-col h-full overflow-hidden relative">
      <template x-if="!selectedLog">
        <div class="absolute inset-0 flex flex-col items-center justify-center text-zinc-400">
          <i class="ph-duotone ph-cursor-click text-4xl mb-4 opacity-50"></i>
          <p>Select a log to view details</p>
        </div>
      </template>

      <template x-if="selectedLog">
        <div class="flex flex-col h-full">
          <!-- Detail Header -->
          <div
            class="bg-white/80 dark:bg-zinc-900/60 backdrop-blur-md border-b border-zinc-200 dark:border-zinc-800 p-4 shrink-0">
            <div class="flex items-start justify-between mb-4">
              <div>
                <h2 class="text-lg font-bold flex items-center gap-2">
                  <span x-text="selectedLog.model"></span>
                </h2>
                <div class="flex items-center gap-3 text-sm text-zinc-500 mt-1">
                  <span class="flex items-center gap-1"><i class="ph-bold ph-clock"></i> <span
                      x-text="Utils.fmtFullTime(selectedLog.timestamp)"></span></span>
                  <span class="flex items-center gap-1"><i class="ph-bold ph-hash"></i> <span
                      x-text="'ID: ' + selectedLog.id"></span></span>
                </div>
              </div>
              <div class="flex flex-col items-end gap-1">
                <span
                  class="px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider flex items-center gap-1.5"
                  :class="selectedLog.success ? 'bg-green-100 dark:bg-green-500/20 text-green-700 dark:text-green-400' : 'bg-red-100 dark:bg-red-500/20 text-red-700 dark:text-red-400'">
                  <i :class="selectedLog.success ? 'ph-bold ph-check' : 'ph-bold ph-warning'"></i>
                  <span x-text="selectedLog.success ? 'SUCCESS' : 'FAILED'"></span>
                </span>
                <span class="font-mono text-xs text-zinc-500"
                  x-text="selectedLog.duration.toFixed(3) + 's latency'"></span>
              </div>
            </div>

            <!-- Tabs -->
            <div class="flex items-center gap-1 border-b border-zinc-200 dark:border-zinc-800">
              <button @click="activeTab = 'overview'"
                class="px-4 py-2 text-sm font-medium border-b-2 transition-colors relative top-px"
                :class="activeTab === 'overview' ? 'border-indigo-500 text-indigo-600 dark:text-indigo-400' : 'border-transparent text-zinc-500 hover:text-zinc-700 dark:hover:text-zinc-300'">
                Overview
              </button>
              <button @click="activeTab = 'content'"
                class="px-4 py-2 text-sm font-medium border-b-2 transition-colors relative top-px"
                :class="activeTab === 'content' ? 'border-indigo-500 text-indigo-600 dark:text-indigo-400' : 'border-transparent text-zinc-500 hover:text-zinc-700 dark:hover:text-zinc-300'">
                Response Content
              </button>
              <button @click="activeTab = 'trace'"
                class="px-4 py-2 text-sm font-medium border-b-2 transition-colors relative top-px"
                :class="activeTab === 'trace' ? 'border-indigo-500 text-indigo-600 dark:text-indigo-400' : 'border-transparent text-zinc-500 hover:text-zinc-700 dark:hover:text-zinc-300'">
                Trace / Tools
              </button>
            </div>
          </div>

          <!-- Detail Content -->
          <div class="flex-1 overflow-y-auto p-6 custom-scrollbar">
            <!-- Details: Overview -->
            <div x-show="activeTab === 'overview'" class="space-y-6">
              <!-- Error Card -->
              <template x-if="selectedLog.error">
                <div class="p-4 rounded-lg bg-red-50 dark:bg-red-500/10 border border-red-200 dark:border-red-500/20">
                  <h3 class="text-sm font-bold text-red-600 dark:text-red-400 mb-2 flex items-center gap-2">
                    <i class="ph-bold ph-warning-circle"></i> Error Details
                  </h3>
                  <pre class="whitespace-pre-wrap text-xs font-mono text-red-600 dark:text-red-300"
                    x-text="selectedLog.error"></pre>
                </div>
              </template>

              <!-- Meta Grid -->
              <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="glass-panel p-3 rounded-lg">
                  <div class="text-xs text-zinc-500 uppercase mb-1">Protocol</div>
                  <div class="font-mono font-bold" x-text="selectedLog.protocol"></div>
                </div>
                <div class="glass-panel p-3 rounded-lg">
                  <div class="text-xs text-zinc-500 uppercase mb-1">Route</div>
                  <div class="font-mono text-sm" x-text="selectedLog.route || '-'"></div>
                </div>
                <div class="glass-panel p-3 rounded-lg">
                  <div class="text-xs text-zinc-500 uppercase mb-1">Endpoint</div>
                  <div class="font-mono text-sm truncate" x-text="selectedLog.endpoint || '-'"
                    :title="selectedLog.endpoint"></div>
                </div>
                <div class="glass-panel p-3 rounded-lg">
                  <div class="text-xs text-zinc-500 uppercase mb-1">Stream</div>
                  <div class="font-mono font-bold" x-text="selectedLog.stream ? 'YES' : 'NO'"></div>
                </div>
              </div>
            </div>

            <!-- Details: Content -->
            <div x-show="activeTab === 'content'" class="space-y-4">
              <div class="glass-panel p-0 rounded-lg overflow-hidden border border-zinc-200 dark:border-zinc-700">
                <div
                  class="bg-zinc-50 dark:bg-zinc-800/50 px-4 py-2 border-b border-zinc-200 dark:border-zinc-700 flex justify-between items-center">
                  <span class="text-xs font-bold text-zinc-500 uppercase">Response Text</span>
                  <button @click="Utils.copyToClipboard(selectedLog.content)"
                    class="text-xs hover:text-indigo-500 transition-colors"><i class="ph-bold ph-copy"></i>
                    Copy</button>
                </div>
                <pre class="p-4 text-sm font-mono whitespace-pre-wrap text-zinc-700 dark:text-zinc-300"
                  x-text="selectedLog.content || '(Empty)'"></pre>
              </div>
            </div>

            <!-- Details: Trace -->
            <div x-show="activeTab === 'trace'" class="space-y-4">
              <div class="glass-panel p-0 rounded-lg overflow-hidden border border-zinc-200 dark:border-zinc-700">
                <div
                  class="bg-zinc-50 dark:bg-zinc-800/50 px-4 py-2 border-b border-zinc-200 dark:border-zinc-700 flex justify-between items-center">
                  <span class="text-xs font-bold text-zinc-500 uppercase">Tool Calls</span>
                </div>
                <pre class="p-4 text-xs font-mono whitespace-pre-wrap text-blue-600 dark:text-blue-400"
                  x-text="JSON.stringify(selectedLog.tool_calls || [], null, 2)"></pre>
              </div>
            </div>
          </div>
        </div>
      </template>
    </div>
  </main>

  <script>
    function logViewer() {
      return {
        targetId: new URLSearchParams(window.location.search).get('target_id'),
        target: {},
        logs: [],
        loading: false,
        search: '',
        filterStatus: 'all',
        selectedId: null,
        activeTab: 'overview', // overview, content, trace

        async init() {
          Utils.initTheme();
          if (this.targetId) {
            this.refresh();
          }
        },

        async refresh() {
          this.loading = true;
          try {
            const [tRes, lRes] = await Promise.all([
              Utils.authFetch(`/api/targets/${this.targetId}`),
              Utils.authFetch(`/api/targets/${this.targetId}/logs?limit=100&scope=latest`)
            ]);

            if (tRes.ok) {
              const resData = await tRes.json();
              this.target = resData.item || resData;
            }

            // Handle logs
            if (lRes.ok) {
              const data = await lRes.json();
              this.logs = (data.items || []).map(l => ({
                ...l,
                tool_calls: typeof l.tool_calls === 'string' ? JSON.parse(l.tool_calls) : l.tool_calls
              }));

              // Select first if none selected
              if (!this.selectedId && this.logs.length > 0) {
                this.selectedId = this.logs[0].id;
              }
            }
          } catch (e) {
            console.error(e);
          } finally {
            this.loading = false;
          }
        },

        get filteredLogs() {
          let items = this.logs;
          if (this.search) {
            const q = this.search.toLowerCase();
            items = items.filter(l =>
              (l.model || '').toLowerCase().includes(q) ||
              (l.content || '').toLowerCase().includes(q)
            );
          }
          if (this.filterStatus === 'success') items = items.filter(l => l.success);
          if (this.filterStatus === 'fail') items = items.filter(l => !l.success);
          return items;
        },

        get selectedLog() {
          return this.logs.find(l => l.id === this.selectedId);
        },

        get stats() {
          const total = this.logs.length;
          const success = this.logs.filter(l => l.success).length;
          const rate = total ? Math.round((success / total) * 100) : 0;

          const successLogs = this.logs.filter(l => l.success);
          const avg = successLogs.length
            ? (successLogs.reduce((a, b) => a + b.duration, 0) / successLogs.length).toFixed(3)
            : '0.000';
          return { successRate: rate, avgLatency: avg };
        },

        selectLog(log) {
          this.selectedId = log.id;
          this.activeTab = 'overview';
        }
      }
    }
  </script>
  <svg xmlns="http://www.w3.org/2000/svg" style="width:0;height:0;position:absolute;">
    <defs>
      <filter id="glass-distortion" x="0%" y="0%" width="100%" height="100%">
        <feTurbulence type="fractalNoise" baseFrequency="0.008 0.008" numOctaves="2" seed="40" result="noise" />
        <feGaussianBlur in="noise" stdDeviation="2" result="blurred" />
        <feDisplacementMap in="SourceGraphic" in2="blurred" scale="30" xChannelSelector="R" yChannelSelector="G" />
      </filter>
    </defs>
  </svg>
</body>

</html>